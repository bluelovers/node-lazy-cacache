"use strict";
const cacache = require("cacache");
const bluebird = require("bluebird");
const crypto = require("crypto");
const event_1 = require("./lib/event");
const util_1 = require("./lib/util");
const fs = require("fs-extra");
const entry_index_1 = require("cacache/lib/entry-index");
const ssri = require("ssri");
const util = require("./lib/util");
class Cacache extends event_1.default {
    static getHashes() {
        return crypto.getHashes();
    }
    static create(options) {
        let SELF_CLASS = this;
        return new SELF_CLASS(options);
    }
    static createAsync(options) {
        let SELF_CLASS = this;
        return bluebird.resolve()
            .bind(SELF_CLASS)
            .then(async function () {
            options = await util_1.getOptionsAsync(options);
            return new SELF_CLASS(options);
        });
    }
    constructor(options) {
        super();
        options = util_1.getOptions(options);
        if (!options.cachePath) {
            let err = new Error(`name or cachePath is undefined`);
            // @ts-ignore
            err.options = options;
            throw err;
        }
        this.cachePath = options.cachePath;
        if (!fs.existsSync(this.cachePath)) {
            if (options.autoCreateDir) {
                util_1.debugConsole.debug(`auto create cachePath: ${this.cachePath}`);
                fs.ensureDirSync(this.cachePath);
            }
            else {
                throw new Error(`發生錯誤 快取目錄不存在 '${this.cachePath}'`);
            }
        }
        util_1.debugConsole.debug(`cachePath: ${this.cachePath}`);
    }
    list() {
        return bluebird
            .resolve(cacache.ls(this.cachePath));
    }
    readData(key, options) {
        return bluebird
            .resolve(cacache.get(this.cachePath, key, options));
    }
    readJSON(key, options) {
        return this.readData(key, options)
            .then(function (ret) {
            let ret2 = ret;
            ret2.json = JSON.parse(ret2.data.toString());
            return ret2;
        });
    }
    readDataIfExists(key, options) {
        let self = this;
        return this.hasData(key, options)
            .bind(this)
            .then(function (v) {
            if (v) {
                return self.readData(key, options);
            }
            return null;
        });
    }
    readJSONIfExists(key, options) {
        let self = this;
        return this.hasData(key, options)
            .bind(this)
            .then(function (v) {
            if (v) {
                return self.readJSON(key, options);
            }
            return null;
        });
    }
    readDataInfo(key, options) {
        return bluebird
            .resolve(cacache.get.info(this.cachePath, key, options));
    }
    hasContent(integrity) {
        return bluebird
            .resolve(cacache.get.hasContent(this.cachePath, integrity));
    }
    hasData(key, options) {
        let self = this;
        return bluebird
            .resolve()
            .bind(this)
            .then(async function () {
            let info = await self.readDataInfo(key);
            if (info
                && options
                && options.ttl
                && (info.time + options.ttl) <= Date.now()) {
                await self.remove(key);
                return null;
            }
            return info || null;
        });
    }
    writeData(key, data, options) {
        return bluebird
            .resolve(cacache.put(this.cachePath, key, data, options))
            .bind(this);
    }
    writeJSON(key, data, options) {
        return this.writeData(key, JSON.stringify(data), options);
    }
    writeDataAndClear(key, data, options) {
        let self = this;
        return this.writeData(key, data, options)
            .tap(function () {
            return self.clearKey(key, true);
        });
    }
    writeJSONAndClear(key, data, options) {
        let self = this;
        return this.writeJSON(key, data, options)
            .tap(function () {
            return self.clearKey(key, true);
        });
    }
    removeAll() {
        return bluebird.resolve(cacache.rm.all(this.cachePath));
    }
    remove(key) {
        return bluebird.resolve(cacache.rm.entry(this.cachePath, key));
    }
    _ssriData(data) {
        return util.ssriData(data);
    }
    _ssriJSON(data, integrity) {
        return this.hashData(JSON.stringify(data));
    }
    hashData(data) {
        return ssri.stringify(this._ssriData(data));
    }
    hashJSON(data) {
        return this.hashData(JSON.stringify(data));
    }
    clearKey(key, keepLatest) {
        let self = this;
        return bluebird
            .resolve(this.bucketEntries(key))
            .bind(this)
            .then(function (ls) {
            if (!ls) {
                return null;
            }
            return bluebird
                .reduce(ls, async function (latest, next) {
                if (next.key === key) {
                    if (latest.time > next.time) {
                        [latest, next] = [next, latest];
                    }
                    if (next.integrity != latest.integrity) {
                        await self.removeContent(latest.integrity);
                    }
                    latest = next;
                }
                return latest;
            })
                .then(async function (latest) {
                if (!keepLatest) {
                    await self.removeContent(latest.integrity);
                    return null;
                }
                return latest;
            });
        })
            .tap(async function (latest) {
            let bucket = self.bucketPath(key);
            if (latest) {
                let entry = Object.assign({}, latest);
                delete entry.path;
                let stringified = JSON.stringify(entry);
                await fs.writeFile(bucket.fullpath, "\n" + `${entry_index_1._hashEntry(stringified)}\t${stringified}`);
            }
            else {
                await fs.remove(bucket.fullpath);
            }
            await util_1.deleteEmpty(self.cachePath);
        });
    }
    removeContent(data_integrity) {
        return bluebird.resolve(cacache.rm.content(this.cachePath, data_integrity));
    }
    clearMemoized() {
        return bluebird.resolve()
            .tap(function () {
            return cacache.clearMemoized();
        });
    }
    createTempDirPath(options) {
        return bluebird.resolve(cacache.tmp.mkdir(this.cachePath, options));
    }
    withTempDirPath(options) {
        return new bluebird((resolve, reject) => {
            cacache.tmp.withTmp(this.cachePath, resolve, options);
        });
    }
    bucketPath(key) {
        return util.bucketPath(key, this.cachePath);
    }
    contentPath(integrity) {
        return util.contentPath(integrity, this.cachePath);
    }
    bucketEntries(key) {
        let self = this;
        return bluebird.resolve()
            .bind(this)
            .then(function () {
            let bucket = self.bucketPath(key);
            if (!fs.existsSync(bucket.fullpath)) {
                return null;
            }
            return fs.readFile(bucket.fullpath, 'utf8')
                .then(data => {
                let entries = [];
                data.split('\n').forEach(entry => {
                    if (!entry) {
                        return;
                    }
                    const pieces = entry.split('\t');
                    if (!pieces[1] || entry_index_1._hashEntry(pieces[1]) !== pieces[0]) {
                        // Hash is no good! Corruption or malice? Doesn't matter!
                        // EJECT EJECT
                        return;
                    }
                    let obj;
                    try {
                        obj = JSON.parse(pieces[1]);
                    }
                    catch (e) {
                        // Entry is corrupted!
                        return;
                    }
                    if (obj) {
                        obj.path = self.contentPath(obj.integrity).fullpath;
                        entries.push(obj);
                    }
                });
                return entries;
            });
        });
    }
    destroy() {
        let self = this;
        return bluebird
            .resolve(self.emit('destroy'))
            .tap(function () {
            return bluebird.all([
                self.removeAllListeners(),
            ]);
        });
    }
}
exports.default = Cacache;
module.exports = Object.freeze(Object.assign(Cacache, exports, {
    default: Cacache,
    Cacache,
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsbUNBQW9DO0FBQ3BDLHFDQUFzQztBQUV0QyxpQ0FBa0M7QUFFbEMsdUNBQTRDO0FBQzVDLHFDQUFxRztBQUNyRywrQkFBZ0M7QUFDaEMseURBQWtFO0FBQ2xFLDZCQUE4QjtBQUM5QixtQ0FBb0M7QUF5Q3BDLE1BQWEsT0FBUSxTQUFRLGVBQWlCO0lBSTdDLE1BQU0sQ0FBQyxTQUFTO1FBRWYsT0FBTyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBaUM7UUFFOUMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLE9BQU8sSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBa0M7UUFFcEQsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXRCLE9BQU8sUUFBUSxDQUFDLE9BQU8sRUFBRTthQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDO2FBQ2hCLElBQUksQ0FBQyxLQUFLO1lBRVYsT0FBTyxHQUFHLE1BQU0sc0JBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV6QyxPQUFPLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUNEO0lBQ0gsQ0FBQztJQUVELFlBQVksT0FBaUM7UUFFNUMsS0FBSyxFQUFFLENBQUM7UUFFUixPQUFPLEdBQUcsaUJBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFDdEI7WUFDQyxJQUFJLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1lBRXRELGFBQWE7WUFDYixHQUFHLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztZQUV0QixNQUFN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Q3pCLENBQUMsQ0FBQTtRQUNILENBQUMsQ0FBQyxDQUNEO0lBQ0gsQ0FBQztDQUNEO0FBMkRELGtCQUFlLE9BQU8sQ0FBQTtBQUd0QixpQkFBUyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRTtJQUN0RCxPQUFPLEVBQUUsT0FBTztJQUNoQixPQUFPO0NBQ1AsQ0FHQSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2FjYWNoZSA9IHJlcXVpcmUoJ2NhY2FjaGUnKTtcbmltcG9ydCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgVHlwZWRBcnJheSA9IE5vZGVKUy5UeXBlZEFycmF5O1xuaW1wb3J0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuaW1wb3J0IHsgSU9wdGlvbnMgYXMgSUdldENhY2hlUGF0aE9wdGlvbnMgfSBmcm9tICdjYWNoZS1wYXRoJztcbmltcG9ydCBFdmVudEVtaXR0ZXJBc3luYyBmcm9tICcuL2xpYi9ldmVudCc7XG5pbXBvcnQgeyBnZXRDYWNoZURpclBhdGgsIGRlYnVnQ29uc29sZSwgZ2V0T3B0aW9uc0FzeW5jLCBnZXRPcHRpb25zLCBkZWxldGVFbXB0eSB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCB7IF9idWNrZXRQYXRoLCBfaGFzaEVudHJ5IH0gZnJvbSAnY2FjYWNoZS9saWIvZW50cnktaW5kZXgnO1xuaW1wb3J0IHNzcmkgPSByZXF1aXJlKCdzc3JpJyk7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJy4vbGliL3V0aWwnKTtcblxuZXhwb3J0IGludGVyZmFjZSBJQ2FjYWNoZU9wdGlvbnMgZXh0ZW5kcyBJQ2FjYWNoZU9wdGlvbnNDb3JlXG57XG5cdC8qKlxuXHQgKiBuYW1lIGZvciBhdXRvIGNyZWF0ZSBjYWNoZVBhdGhcblx0ICovXG5cdG5hbWU/OiBzdHJpbmcsXG5cdC8qKlxuXHQgKiByb290IHBhdGggb2YgY2FjaGUgc2F2ZVxuXHQgKi9cblx0Y2FjaGVQYXRoPzogc3RyaW5nLFxuXHQvKipcblx0ICogdXNlIGdsb2JhbCBjYWNoZSBwYXRoIGZpcnN0XG5cdCAqL1xuXHR1c2VHbG9iYWxDYWNoZT86IGJvb2xlYW4sXG5cblx0Z2V0Q2FjaGVQYXRoT3B0aW9ucz86IElHZXRDYWNoZVBhdGhPcHRpb25zLFxuXG5cdC8qKlxuXHQgKiBhdXRvIGNyZWF0ZSBjYWNoZVBhdGggaWYgbm90IGV4aXN0c1xuXHQgKi9cblx0YXV0b0NyZWF0ZURpcj86IGJvb2xlYW4sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVPcHRpb25zQ29yZTxNID0gYW55Plxue1xuXHRpbnRlZ3JpdHk/LFxuXHRhbGdvcml0aG1zPzogSUNhY2FjaGVBbGdvcml0aG0sXG5cdG1lbW9pemU/LFxuXHR1aWQ/XG5cdGdpdD9cblxuXHRtZXRhZGF0YT86IE0sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVPcHRpb25zUGx1cyBleHRlbmRzIElDYWNhY2hlT3B0aW9uc0NvcmVcbntcblx0dHRsPzogbnVtYmVyLFxufVxuXG5leHBvcnQgY2xhc3MgQ2FjYWNoZSBleHRlbmRzIEV2ZW50RW1pdHRlckFzeW5jXG57XG5cdGNhY2hlUGF0aDogc3RyaW5nO1xuXG5cdHN0YXRpYyBnZXRIYXNoZXMoKVxuXHR7XG5cdFx0cmV0dXJuIGNyeXB0by5nZXRIYXNoZXMoKTtcblx0fVxuXG5cdHN0YXRpYyBjcmVhdGUob3B0aW9uczogc3RyaW5nIHwgSUNhY2FjaGVPcHRpb25zKVxuXHR7XG5cdFx0bGV0IFNFTEZfQ0xBU1MgPSB0aGlzO1xuXHRcdHJldHVybiBuZXcgU0VMRl9DTEFTUyhvcHRpb25zKTtcblx0fVxuXG5cdHN0YXRpYyBjcmVhdGVBc3luYyhvcHRpb25zPzogc3RyaW5nIHwgSUNhY2FjaGVPcHRpb25zKVxuXHR7XG5cdFx0bGV0IFNFTEZfQ0xBU1MgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoKVxuXHRcdFx0LmJpbmQoU0VMRl9DTEFTUylcblx0XHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uICgpXG5cdFx0XHR7XG5cdFx0XHRcdG9wdGlvbnMgPSBhd2FpdCBnZXRPcHRpb25zQXN5bmMob3B0aW9ucyk7XG5cblx0XHRcdFx0cmV0dXJuIG5ldyBTRUxGX0NMQVNTKG9wdGlvbnMpO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM6IHN0cmluZyB8IElDYWNhY2hlT3B0aW9ucylcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHRvcHRpb25zID0gZ2V0T3B0aW9ucyhvcHRpb25zKTtcblxuXHRcdGlmICghb3B0aW9ucy5jYWNoZVBhdGgpXG5cdFx0e1xuXHRcdFx0bGV0IGVyciA9IG5ldyBFcnJvcihgbmFtZSBvciBjYWNoZVBhdGggaXMgdW5kZWZpbmVkYCk7XG5cblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdGVyci5vcHRpb25zID0gb3B0aW9ucztcblxuXHRcdFx0dGhyb3cgZXJyO1xuXHRcdH1cblxuXHRcdHRoaXMuY2FjaGVQYXRoID0gb3B0aW9ucy5jYWNoZVBhdGg7XG5cblx0XHRpZiAoIWZzLmV4aXN0c1N5bmModGhpcy5jYWNoZVBhdGgpKVxuXHRcdHtcblx0XHRcdGlmIChvcHRpb25zLmF1dG9DcmVhdGVEaXIpXG5cdFx0XHR7XG5cdFx0XHRcdGRlYnVnQ29uc29sZS5kZWJ1ZyhgYXV0byBjcmVhdGUgY2FjaGVQYXRoOiAke3RoaXMuY2FjaGVQYXRofWApO1xuXHRcdFx0XHRmcy5lbnN1cmVEaXJTeW5jKHRoaXMuY2FjaGVQYXRoKVxuXHRcdFx0fVxuXHRcdFx0ZWxzZVxuXHRcdFx0e1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYOeZvOeUn+mMr+iqpCDlv6vlj5bnm67pjITkuI3lrZjlnKggJyR7dGhpcy5jYWNoZVBhdGh9J2ApO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGRlYnVnQ29uc29sZS5kZWJ1ZyhgY2FjaGVQYXRoOiAke3RoaXMuY2FjaGVQYXRofWApO1xuXHR9XG5cblx0bGlzdDxNPigpOiBibHVlYmlyZDxJQ2FjYWNoZUxpc3Q8TT4+XG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKGNhY2FjaGUubHModGhpcy5jYWNoZVBhdGgpKVxuXHRcdFx0O1xuXHR9XG5cblx0cmVhZERhdGE8RCA9IEJ1ZmZlciwgTSA9IGFueT4oa2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmUsXG5cdCk6IGJsdWViaXJkPElDYWNhY2hlRGF0YTxELCBNPj5cblx0e1xuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUoY2FjYWNoZS5nZXQodGhpcy5jYWNoZVBhdGgsIGtleSwgb3B0aW9ucykpO1xuXHR9XG5cblx0cmVhZEpTT048RCA9IGFueSwgTSA9IGFueT4oa2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmUsXG5cdClcblx0e1xuXHRcdHJldHVybiB0aGlzLnJlYWREYXRhKGtleSwgb3B0aW9ucylcblx0XHRcdC50aGVuKGZ1bmN0aW9uIChyZXQpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCByZXQyID0gcmV0IGFzIGFueSBhcyBJQ2FjYWNoZUpTT048RCwgTT47XG5cblx0XHRcdFx0cmV0Mi5qc29uID0gSlNPTi5wYXJzZShyZXQyLmRhdGEudG9TdHJpbmcoKSk7XG5cblx0XHRcdFx0cmV0dXJuIHJldDI7XG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0cmVhZERhdGFJZkV4aXN0czxEID0gQnVmZmVyLCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogSUNhY2FjaGVPcHRpb25zUGx1cyxcblx0KTogYmx1ZWJpcmQ8SUNhY2FjaGVEYXRhPEQsIE0+PlxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIHRoaXMuaGFzRGF0YShrZXksIG9wdGlvbnMpXG5cdFx0XHQuYmluZCh0aGlzKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKHRoaXM6IENhY2FjaGUsIHYpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIHNlbGYucmVhZERhdGE8RCwgTT4oa2V5LCBvcHRpb25zKVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0cmVhZEpTT05JZkV4aXN0czxEID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogSUNhY2FjaGVPcHRpb25zUGx1cyxcblx0KTogYmx1ZWJpcmQ8SUNhY2FjaGVKU09OPEQsIE0+PlxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIHRoaXMuaGFzRGF0YShrZXksIG9wdGlvbnMpXG5cdFx0XHQuYmluZCh0aGlzKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKHRoaXM6IENhY2FjaGUsIHYpXG5cdFx0XHR7XG5cdFx0XHRcdGlmICh2KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIHNlbGYucmVhZEpTT048RCwgTT4oa2V5LCBvcHRpb25zKVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0cmVhZERhdGFJbmZvPE0+KGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlLFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZUxpc3RFbnRyeTxNPj5cblx0e1xuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUoY2FjYWNoZS5nZXQuaW5mbyh0aGlzLmNhY2hlUGF0aCwga2V5LCBvcHRpb25zKSk7XG5cdH1cblxuXHRoYXNDb250ZW50PE8+KGludGVncml0eTogc3RyaW5nKTogYmx1ZWJpcmQ8SUNhY2FjaGVEYXRhSGFzQ29udGVudDxPPj5cblx0e1xuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUoY2FjYWNoZS5nZXQuaGFzQ29udGVudCh0aGlzLmNhY2hlUGF0aCwgaW50ZWdyaXR5KSk7XG5cdH1cblxuXHRoYXNEYXRhPE0+KGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNQbHVzLFxuXHQpXG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKClcblx0XHRcdC5iaW5kKHRoaXMpXG5cdFx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAoKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgaW5mbyA9IGF3YWl0IHNlbGYucmVhZERhdGFJbmZvPE0+KGtleSk7XG5cblx0XHRcdFx0aWYgKGluZm9cblx0XHRcdFx0XHQmJiBvcHRpb25zXG5cdFx0XHRcdFx0JiYgb3B0aW9ucy50dGxcblx0XHRcdFx0XHQmJiAoaW5mby50aW1lICsgb3B0aW9ucy50dGwpIDw9IERhdGUubm93KClcblx0XHRcdFx0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YXdhaXQgc2VsZi5yZW1vdmUoa2V5KTtcblxuXHRcdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIGluZm8gfHwgbnVsbDtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHR3cml0ZURhdGE8TyA9IGFueSwgTSA9IGFueT4oa2V5OiBzdHJpbmcsXG5cdFx0ZGF0YTogc3RyaW5nIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5LFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlPE0+LFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZUludGVncml0eTxJQ2FjYWNoZUhhc2g8Tz4+PlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShjYWNhY2hlLnB1dCh0aGlzLmNhY2hlUGF0aCwga2V5LCBkYXRhLCBvcHRpb25zKSlcblx0XHRcdC5iaW5kKHRoaXMpXG5cdFx0XHQ7XG5cdH1cblxuXHR3cml0ZUpTT048TyA9IGFueSwgTSA9IGFueT4oa2V5OiBzdHJpbmcsIGRhdGEsIG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlPE0+KVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMud3JpdGVEYXRhPE8sIE0+KGtleSwgSlNPTi5zdHJpbmdpZnkoZGF0YSksIG9wdGlvbnMpO1xuXHR9XG5cblx0d3JpdGVEYXRhQW5kQ2xlYXI8TyA9IGFueSwgTSA9IGFueT4oa2V5OiBzdHJpbmcsXG5cdFx0ZGF0YTogc3RyaW5nIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5LFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlPE0+LFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZUludGVncml0eTxJQ2FjYWNoZUhhc2g8Tz4+PlxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIHRoaXMud3JpdGVEYXRhPE8sIE0+KGtleSwgZGF0YSwgb3B0aW9ucylcblx0XHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHNlbGYuY2xlYXJLZXkoa2V5LCB0cnVlKTtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHR3cml0ZUpTT05BbmRDbGVhcjxPID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRkYXRhLFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlPE0+LFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZUludGVncml0eTxJQ2FjYWNoZUhhc2g8Tz4+PlxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIHRoaXMud3JpdGVKU09OPE8sIE0+KGtleSwgZGF0YSwgb3B0aW9ucylcblx0XHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHNlbGYuY2xlYXJLZXkoa2V5LCB0cnVlKTtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHRyZW1vdmVBbGwoKTogYmx1ZWJpcmQ8dm9pZD5cblx0e1xuXHRcdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKGNhY2FjaGUucm0uYWxsKHRoaXMuY2FjaGVQYXRoKSk7XG5cdH1cblxuXHRyZW1vdmUoa2V5OiBzdHJpbmcpOiBibHVlYmlyZDx2b2lkPlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoY2FjYWNoZS5ybS5lbnRyeSh0aGlzLmNhY2hlUGF0aCwga2V5KSk7XG5cdH1cblxuXHRfc3NyaURhdGEoZGF0YTogc3RyaW5nIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5KTogc3RyaW5nXG5cdHtcblx0XHRyZXR1cm4gdXRpbC5zc3JpRGF0YShkYXRhKVxuXHR9XG5cblx0X3NzcmlKU09OKGRhdGEsIGludGVncml0eT86IHN0cmluZylcblx0e1xuXHRcdHJldHVybiB0aGlzLmhhc2hEYXRhKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcblx0fVxuXG5cdGhhc2hEYXRhKGRhdGE6IHN0cmluZyB8IERhdGFWaWV3IHwgVHlwZWRBcnJheSk6IHN0cmluZ1xuXHR7XG5cdFx0cmV0dXJuIHNzcmkuc3RyaW5naWZ5KHRoaXMuX3NzcmlEYXRhKGRhdGEpKTtcblx0fVxuXG5cdGhhc2hKU09OKGRhdGEpXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5oYXNoRGF0YShKU09OLnN0cmluZ2lmeShkYXRhKSk7XG5cdH1cblxuXHRjbGVhcktleTxNID0gYW55PihrZXk6IHN0cmluZywga2VlcExhdGVzdD86IGJvb2xlYW4pXG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKHRoaXMuYnVja2V0RW50cmllcyhrZXkpKVxuXHRcdFx0LmJpbmQodGhpcylcblx0XHRcdC50aGVuKGZ1bmN0aW9uIChscylcblx0XHRcdHtcblx0XHRcdFx0aWYgKCFscylcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHRcdFx0LnJlZHVjZShscywgYXN5bmMgZnVuY3Rpb24gKGxhdGVzdDogSUNhY2FjaGVMaXN0RW50cnk8TT4sIG5leHQ6IElDYWNhY2hlTGlzdEVudHJ5PE0+KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGlmIChuZXh0LmtleSA9PT0ga2V5KVxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRpZiAobGF0ZXN0LnRpbWUgPiBuZXh0LnRpbWUpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRbbGF0ZXN0LCBuZXh0XSA9IFtuZXh0LCBsYXRlc3RdO1xuXHRcdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdFx0aWYgKG5leHQuaW50ZWdyaXR5ICE9IGxhdGVzdC5pbnRlZ3JpdHkpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRhd2FpdCBzZWxmLnJlbW92ZUNvbnRlbnQobGF0ZXN0LmludGVncml0eSk7XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRsYXRlc3QgPSBuZXh0O1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRyZXR1cm4gbGF0ZXN0O1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0LnRoZW4oYXN5bmMgZnVuY3Rpb24gKGxhdGVzdClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRpZiAoIWtlZXBMYXRlc3QpXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdGF3YWl0IHNlbGYucmVtb3ZlQ29udGVudChsYXRlc3QuaW50ZWdyaXR5KTtcblxuXHRcdFx0XHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0cmV0dXJuIGxhdGVzdFxuXHRcdFx0XHRcdH0pXG5cdFx0XHR9KVxuXHRcdFx0LnRhcChhc3luYyBmdW5jdGlvbiAobGF0ZXN0KVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgYnVja2V0ID0gc2VsZi5idWNrZXRQYXRoKGtleSk7XG5cblx0XHRcdFx0aWYgKGxhdGVzdClcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBlbnRyeSA9IE9iamVjdC5hc3NpZ24oe30sIGxhdGVzdCk7XG5cblx0XHRcdFx0XHRkZWxldGUgZW50cnkucGF0aDtcblxuXHRcdFx0XHRcdGxldCBzdHJpbmdpZmllZCA9IEpTT04uc3RyaW5naWZ5KGVudHJ5KTtcblxuXHRcdFx0XHRcdGF3YWl0IGZzLndyaXRlRmlsZShidWNrZXQuZnVsbHBhdGgsIFwiXFxuXCIgKyBgJHtfaGFzaEVudHJ5KHN0cmluZ2lmaWVkKX1cXHQke3N0cmluZ2lmaWVkfWApXG5cdFx0XHRcdH1cblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0YXdhaXQgZnMucmVtb3ZlKGJ1Y2tldC5mdWxscGF0aClcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGF3YWl0IGRlbGV0ZUVtcHR5KHNlbGYuY2FjaGVQYXRoKTtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHRyZW1vdmVDb250ZW50KGRhdGFfaW50ZWdyaXR5OiBzdHJpbmcpOiBibHVlYmlyZDx2b2lkPlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoY2FjYWNoZS5ybS5jb250ZW50KHRoaXMuY2FjaGVQYXRoLCBkYXRhX2ludGVncml0eSkpO1xuXHR9XG5cblx0Y2xlYXJNZW1vaXplZCgpXG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZSgpXG5cdFx0XHQudGFwKGZ1bmN0aW9uICgpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybiBjYWNhY2hlLmNsZWFyTWVtb2l6ZWQoKVxuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdGNyZWF0ZVRlbXBEaXJQYXRoKG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlKTogYmx1ZWJpcmQ8c3RyaW5nPlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoY2FjYWNoZS50bXAubWtkaXIodGhpcy5jYWNoZVBhdGgsIG9wdGlvbnMpKTtcblx0fVxuXG5cdHdpdGhUZW1wRGlyUGF0aChvcHRpb25zPzogSUNhY2FjaGVPcHRpb25zQ29yZSk6IGJsdWViaXJkPHN0cmluZz5cblx0e1xuXHRcdHJldHVybiBuZXcgYmx1ZWJpcmQoKHJlc29sdmUsIHJlamVjdCkgPT5cblx0XHR7XG5cdFx0XHRjYWNhY2hlLnRtcC53aXRoVG1wKHRoaXMuY2FjaGVQYXRoLCByZXNvbHZlLCBvcHRpb25zKVxuXHRcdH0pO1xuXHR9XG5cblx0YnVja2V0UGF0aChrZXk6IHN0cmluZylcblx0e1xuXHRcdHJldHVybiB1dGlsLmJ1Y2tldFBhdGgoa2V5LCB0aGlzLmNhY2hlUGF0aCk7XG5cdH1cblxuXHRjb250ZW50UGF0aChpbnRlZ3JpdHk6IHN0cmluZylcblx0e1xuXHRcdHJldHVybiB1dGlsLmNvbnRlbnRQYXRoKGludGVncml0eSwgdGhpcy5jYWNoZVBhdGgpO1xuXHR9XG5cblx0YnVja2V0RW50cmllczxNID0gYW55PihrZXk6IHN0cmluZylcblx0e1xuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKClcblx0XHRcdC5iaW5kKHRoaXMpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAodGhpczogQ2FjYWNoZSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IGJ1Y2tldCA9IHNlbGYuYnVja2V0UGF0aChrZXkpO1xuXG5cdFx0XHRcdGlmICghZnMuZXhpc3RzU3luYyhidWNrZXQuZnVsbHBhdGgpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gZnMucmVhZEZpbGUoYnVja2V0LmZ1bGxwYXRoLCAndXRmOCcpXG5cdFx0XHRcdFx0LnRoZW4oZGF0YSA9PlxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGxldCBlbnRyaWVzID0gW10gYXMgSUNhY2FjaGVMaXN0RW50cnk8TT5bXTtcblxuXHRcdFx0XHRcdFx0ZGF0YS5zcGxpdCgnXFxuJykuZm9yRWFjaChlbnRyeSA9PlxuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRpZiAoIWVudHJ5KVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuXG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0Y29uc3QgcGllY2VzID0gZW50cnkuc3BsaXQoJ1xcdCcpO1xuXHRcdFx0XHRcdFx0XHRpZiAoIXBpZWNlc1sxXSB8fCBfaGFzaEVudHJ5KHBpZWNlc1sxXSkgIT09IHBpZWNlc1swXSlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdC8vIEhhc2ggaXMgbm8gZ29vZCEgQ29ycnVwdGlvbiBvciBtYWxpY2U/IERvZXNuJ3QgbWF0dGVyIVxuXHRcdFx0XHRcdFx0XHRcdC8vIEVKRUNUIEVKRUNUXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuXG5cdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0bGV0IG9iajtcblx0XHRcdFx0XHRcdFx0dHJ5XG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRvYmogPSBKU09OLnBhcnNlKHBpZWNlc1sxXSlcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRjYXRjaCAoZSlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdC8vIEVudHJ5IGlzIGNvcnJ1cHRlZCFcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm5cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRpZiAob2JqKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0b2JqLnBhdGggPSBzZWxmLmNvbnRlbnRQYXRoKG9iai5pbnRlZ3JpdHkpLmZ1bGxwYXRoO1xuXG5cdFx0XHRcdFx0XHRcdFx0ZW50cmllcy5wdXNoKG9iailcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fSk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gZW50cmllc1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdFx0O1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdGRlc3Ryb3koKVxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShzZWxmLmVtaXQoJ2Rlc3Ryb3knKSlcblx0XHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGJsdWViaXJkLmFsbChbXG5cdFx0XHRcdFx0c2VsZi5yZW1vdmVBbGxMaXN0ZW5lcnMoKSxcblx0XHRcdFx0XSlcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cbn1cblxudHlwZSB2YWx1ZW9mPFQ+ID0gVFtrZXlvZiBUXVxuXG5leHBvcnQgdHlwZSBJQ2FjYWNoZUFsZ29yaXRobSA9ICdzaGE1MTInIHwgc3RyaW5nO1xuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlSW50ZWdyaXR5PFQgPSBJQ2FjYWNoZUhhc2g+XG57XG5cdHNoYTUxMj86IFRbXSxcblxuXHRbazogc3RyaW5nXTogVFtdLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlSGFzaDxPID0gYW55Plxue1xuXHRzb3VyY2U6IHN0cmluZyxcblx0YWxnb3JpdGhtOiBJQ2FjYWNoZUFsZ29yaXRobSxcblx0ZGlnZXN0OiBzdHJpbmcsXG5cdG9wdGlvbnM6IE9bXSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ2FjYWNoZUxpc3RFbnRyeTxNID0gYW55Plxue1xuXHRrZXk6IHN0cmluZyxcblx0aW50ZWdyaXR5OiBzdHJpbmcsXG5cdHBhdGg6IHN0cmluZyxcblx0c2l6ZTogbnVtYmVyLFxuXHR0aW1lOiBudW1iZXIsXG5cdG1ldGFkYXRhOiBNLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlTGlzdDxNID0gYW55Plxue1xuXHRbazogc3RyaW5nXTogSUNhY2FjaGVMaXN0RW50cnk8TT4sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVEYXRhPEQgPSBCdWZmZXIsIE0gPSBhbnk+XG57XG5cdG1ldGFkYXRhOiBNLFxuXHRpbnRlZ3JpdHk6IHN0cmluZyxcblx0ZGF0YTogRCB8IEJ1ZmZlciB8IERhdGFWaWV3IHwgVHlwZWRBcnJheSxcblx0c2l6ZTogc3RyaW5nLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlSlNPTjxEID0gQnVmZmVyLCBNID0gYW55Plxue1xuXHRtZXRhZGF0YTogTSxcblx0aW50ZWdyaXR5OiBzdHJpbmcsXG5cdGRhdGE6IEJ1ZmZlciB8IERhdGFWaWV3IHwgVHlwZWRBcnJheSxcblx0c2l6ZTogc3RyaW5nLFxuXHRqc29uOiBELFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlRGF0YUhhc0NvbnRlbnQ8TyA9IGFueT5cbntcblx0c3JpOiBJQ2FjYWNoZUhhc2g8Tz4sXG5cdHNpemU6IG51bWJlcixcbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2FjYWNoZVxuXG4vLyBAdHMtaWdub3JlXG5leHBvcnQgPSBPYmplY3QuZnJlZXplKE9iamVjdC5hc3NpZ24oQ2FjYWNoZSwgZXhwb3J0cywge1xuXHRkZWZhdWx0OiBDYWNhY2hlLFxuXHRDYWNhY2hlLFxufSkgYXMgdHlwZW9mIENhY2FjaGUgJiB7XG5cdGRlZmF1bHQ6IHR5cGVvZiBDYWNhY2hlLFxuXHRDYWNhY2hlOiB0eXBlb2YgQ2FjYWNoZSxcbn0pO1xuIl19