"use strict";
const cacache = require("cacache");
const bluebird = require("bluebird");
const crypto = require("crypto");
const event_1 = require("./lib/event");
const util_1 = require("./lib/util");
const fs = require("fs-extra");
const entry_index_1 = require("cacache/lib/entry-index");
const ssri = require("ssri");
const util = require("./lib/util");
class Cacache extends event_1.default {
    static getHashes() {
        return crypto.getHashes();
    }
    static create(options) {
        let SELF_CLASS = this;
        return new SELF_CLASS(options);
    }
    static createAsync(options) {
        let SELF_CLASS = this;
        return bluebird.resolve()
            .bind(SELF_CLASS)
            .then(async function () {
            options = await util_1.getOptionsAsync(options);
            return new SELF_CLASS(options);
        });
    }
    constructor(options) {
        super();
        options = util_1.getOptions(options);
        if (!options.cachePath) {
            let err = new Error(`name or cachePath is undefined`);
            // @ts-ignore
            err.options = options;
            throw err;
        }
        this.cachePath = options.cachePath;
        if (!fs.existsSync(this.cachePath)) {
            if (options.autoCreateDir) {
                util_1.debugConsole.debug(`auto create cachePath: ${this.cachePath}`);
                fs.ensureDirSync(this.cachePath);
            }
            else {
                throw new Error(`發生錯誤 快取目錄不存在 '${this.cachePath}'`);
            }
        }
        util_1.debugConsole.debug(`cachePath: ${this.cachePath}`);
    }
    list() {
        return bluebird
            .resolve(cacache.ls(this.cachePath));
    }
    readData(key, options) {
        return bluebird
            .resolve(cacache.get(this.cachePath, key, options));
    }
    readJSON(key, options) {
        return this.readData(key, options)
            .then(function (ret) {
            let ret2 = ret;
            ret2.json = JSON.parse(ret2.data.toString());
            return ret2;
        });
    }
    readDataIfExists(key, options) {
        let self = this;
        return this.hasData(key, options)
            .bind(this)
            .then(function (v) {
            if (v) {
                return self.readData(key, options);
            }
            return null;
        });
    }
    readJSONIfExists(key, options) {
        let self = this;
        return this.hasData(key, options)
            .bind(this)
            .then(function (v) {
            if (v) {
                return self.readJSON(key, options);
            }
            return null;
        });
    }
    readDataInfo(key, options) {
        return bluebird
            .resolve(cacache.get.info(this.cachePath, key, options));
    }
    hasContent(integrity) {
        return bluebird
            .resolve(cacache.get.hasContent(this.cachePath, integrity));
    }
    hasData(key, options) {
        let self = this;
        return bluebird
            .resolve()
            .bind(this)
            .then(async function () {
            let info = await self.readDataInfo(key);
            if (info
                && options
                && options.ttl
                && (info.time + options.ttl) <= Date.now()) {
                await self.remove(key);
                return null;
            }
            return info || null;
        });
    }
    writeData(key, data, options) {
        return bluebird
            .resolve(cacache.put(this.cachePath, key, data, options))
            .bind(this);
    }
    writeJSON(key, data, options) {
        return this.writeData(key, JSON.stringify(data), options);
    }
    writeDataAndClear(key, data, options) {
        let self = this;
        return this.writeData(key, data, options)
            .tap(function () {
            return self.clearKey(key, true);
        });
    }
    writeJSONAndClear(key, data, options) {
        let self = this;
        return this.writeJSON(key, data, options)
            .tap(function () {
            return self.clearKey(key, true);
        });
    }
    removeAll() {
        return bluebird.resolve(cacache.rm.all(this.cachePath));
    }
    remove(key) {
        return bluebird.resolve(cacache.rm.entry(this.cachePath, key));
    }
    _ssriData(data) {
        return util.ssriData(data);
    }
    _ssriJSON(data, integrity) {
        return this.hashData(JSON.stringify(data));
    }
    hashData(data) {
        return ssri.stringify(this._ssriData(data));
    }
    hashJSON(data) {
        return this.hashData(JSON.stringify(data));
    }
    clearKey(key, keepLatest) {
        let self = this;
        return bluebird
            .resolve(this.bucketEntries(key))
            .bind(this)
            .then(function (ls) {
            if (!ls) {
                return null;
            }
            return bluebird
                .reduce(ls, async function (latest, next) {
                if (next.key === key) {
                    if (latest.time > next.time) {
                        [latest, next] = [next, latest];
                    }
                    if (next.integrity != latest.integrity) {
                        await self.removeContent(latest.integrity);
                    }
                    latest = next;
                }
                return latest;
            })
                .then(async function (latest) {
                if (!keepLatest) {
                    await self.removeContent(latest.integrity);
                    return null;
                }
                return latest;
            });
        })
            .tap(async function (latest) {
            let bucket = self.bucketPath(key);
            if (latest) {
                let entry = Object.assign({}, latest);
                delete entry.path;
                let stringified = JSON.stringify(entry);
                await fs.writeFile(bucket.fullpath, "\n" + `${entry_index_1._hashEntry(stringified)}\t${stringified}`);
            }
            else {
                await fs.remove(bucket.fullpath);
            }
            await util_1.deleteEmpty(self.cachePath);
        });
    }
    removeContent(data_integrity) {
        return bluebird.resolve(cacache.rm.content(this.cachePath, data_integrity));
    }
    clearMemoized() {
        return bluebird.resolve()
            .tap(function () {
            return cacache.clearMemoized();
        });
    }
    createTempDirPath(options) {
        return bluebird.resolve(cacache.tmp.mkdir(this.cachePath, options));
    }
    withTempDirPath(options) {
        return new bluebird((resolve, reject) => {
            cacache.tmp.withTmp(this.cachePath, resolve, options);
        });
    }
    bucketPath(key) {
        return util.bucketPath(key, this.cachePath);
    }
    contentPath(integrity) {
        return util.contentPath(integrity, this.cachePath);
    }
    bucketEntries(key) {
        let self = this;
        return bluebird.resolve()
            .bind(this)
            .then(function () {
            let bucket = self.bucketPath(key);
            if (!fs.existsSync(bucket.fullpath)) {
                return null;
            }
            return fs.readFile(bucket.fullpath, 'utf8')
                .then(data => {
                let entries = [];
                data.split('\n').forEach(entry => {
                    if (!entry) {
                        return;
                    }
                    const pieces = entry.split('\t');
                    if (!pieces[1] || entry_index_1._hashEntry(pieces[1]) !== pieces[0]) {
                        // Hash is no good! Corruption or malice? Doesn't matter!
                        // EJECT EJECT
                        return;
                    }
                    let obj;
                    try {
                        obj = JSON.parse(pieces[1]);
                    }
                    catch (e) {
                        // Entry is corrupted!
                        return;
                    }
                    if (obj) {
                        obj.path = self.contentPath(obj.integrity).fullpath;
                        entries.push(obj);
                    }
                });
                return entries;
            });
        });
    }
    destroy() {
        let self = this;
        return bluebird
            .resolve(self.emit('destroy'))
            .tap(function () {
            return bluebird.all([
                self.removeAllListeners(),
            ]);
        });
    }
}
exports.default = Cacache;
module.exports = Object.freeze(Object.assign(Cacache, exports, {
    default: Cacache,
    Cacache,
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsbUNBQW9DO0FBQ3BDLHFDQUFzQztBQUV0QyxpQ0FBa0M7QUFFbEMsdUNBQTRDO0FBQzVDLHFDQUFxRztBQUNyRywrQkFBK0I7QUFDL0IseURBQWtFO0FBQ2xFLDZCQUE4QjtBQUM5QixtQ0FBb0M7QUF5Q3BDLE1BQWEsT0FBUSxTQUFRLGVBQWlCO0lBSTdDLE1BQU0sQ0FBQyxTQUFTO1FBRWYsT0FBTyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDM0IsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBaUM7UUFFOUMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLE9BQU8sSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBa0M7UUFFcEQsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBRXRCLE9BQU8sUUFBUSxDQUFDLE9BQU8sRUFBRTthQUN2QixJQUFJLENBQUMsVUFBVSxDQUFDO2FBQ2hCLElBQUksQ0FBQyxLQUFLO1lBRVYsT0FBTyxHQUFHLE1BQU0sc0JBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUV6QyxPQUFPLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUNEO0lBQ0gsQ0FBQztJQUVELFlBQVksT0FBaUM7UUFFNUMsS0FBSyxFQUFFLENBQUM7UUFFUixPQUFPLEdBQUcsaUJBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUU5QixJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFDdEI7WUFDQyxJQUFJLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1lBRXRELGFBQWE7WUFDYixHQUFHLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztZQUV0QixNQUFN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Q3pCLENBQUMsQ0FBQTtRQUNILENBQUMsQ0FBQyxDQUNEO0lBQ0gsQ0FBQztDQUNEO0FBMkRELGtCQUFlLE9BQU8sQ0FBQTtBQUd0QixpQkFBUyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRTtJQUN0RCxPQUFPLEVBQUUsT0FBTztJQUNoQixPQUFPO0NBQ1AsQ0FHQSxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2FjYWNoZSA9IHJlcXVpcmUoJ2NhY2FjaGUnKTtcbmltcG9ydCBibHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgVHlwZWRBcnJheSA9IE5vZGVKUy5UeXBlZEFycmF5O1xuaW1wb3J0IGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuaW1wb3J0IHsgSU9wdGlvbnMgYXMgSUdldENhY2hlUGF0aE9wdGlvbnMgfSBmcm9tICdjYWNoZS1wYXRoJztcbmltcG9ydCBFdmVudEVtaXR0ZXJBc3luYyBmcm9tICcuL2xpYi9ldmVudCc7XG5pbXBvcnQgeyBnZXRDYWNoZURpclBhdGgsIGRlYnVnQ29uc29sZSwgZ2V0T3B0aW9uc0FzeW5jLCBnZXRPcHRpb25zLCBkZWxldGVFbXB0eSB9IGZyb20gJy4vbGliL3V0aWwnO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMtZXh0cmEnO1xuaW1wb3J0IHsgX2J1Y2tldFBhdGgsIF9oYXNoRW50cnkgfSBmcm9tICdjYWNhY2hlL2xpYi9lbnRyeS1pbmRleCc7XG5pbXBvcnQgc3NyaSA9IHJlcXVpcmUoJ3NzcmknKTtcbmltcG9ydCB1dGlsID0gcmVxdWlyZSgnLi9saWIvdXRpbCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlT3B0aW9ucyBleHRlbmRzIElDYWNhY2hlT3B0aW9uc0NvcmVcbntcblx0LyoqXG5cdCAqIG5hbWUgZm9yIGF1dG8gY3JlYXRlIGNhY2hlUGF0aFxuXHQgKi9cblx0bmFtZT86IHN0cmluZyxcblx0LyoqXG5cdCAqIHJvb3QgcGF0aCBvZiBjYWNoZSBzYXZlXG5cdCAqL1xuXHRjYWNoZVBhdGg/OiBzdHJpbmcsXG5cdC8qKlxuXHQgKiB1c2UgZ2xvYmFsIGNhY2hlIHBhdGggZmlyc3Rcblx0ICovXG5cdHVzZUdsb2JhbENhY2hlPzogYm9vbGVhbixcblxuXHRnZXRDYWNoZVBhdGhPcHRpb25zPzogSUdldENhY2hlUGF0aE9wdGlvbnMsXG5cblx0LyoqXG5cdCAqIGF1dG8gY3JlYXRlIGNhY2hlUGF0aCBpZiBub3QgZXhpc3RzXG5cdCAqL1xuXHRhdXRvQ3JlYXRlRGlyPzogYm9vbGVhbixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ2FjYWNoZU9wdGlvbnNDb3JlPE0gPSBhbnk+XG57XG5cdGludGVncml0eT8sXG5cdGFsZ29yaXRobXM/OiBJQ2FjYWNoZUFsZ29yaXRobSxcblx0bWVtb2l6ZT8sXG5cdHVpZD9cblx0Z2l0P1xuXG5cdG1ldGFkYXRhPzogTSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ2FjYWNoZU9wdGlvbnNQbHVzIGV4dGVuZHMgSUNhY2FjaGVPcHRpb25zQ29yZVxue1xuXHR0dGw/OiBudW1iZXIsXG59XG5cbmV4cG9ydCBjbGFzcyBDYWNhY2hlIGV4dGVuZHMgRXZlbnRFbWl0dGVyQXN5bmNcbntcblx0Y2FjaGVQYXRoOiBzdHJpbmc7XG5cblx0c3RhdGljIGdldEhhc2hlcygpXG5cdHtcblx0XHRyZXR1cm4gY3J5cHRvLmdldEhhc2hlcygpO1xuXHR9XG5cblx0c3RhdGljIGNyZWF0ZShvcHRpb25zOiBzdHJpbmcgfCBJQ2FjYWNoZU9wdGlvbnMpXG5cdHtcblx0XHRsZXQgU0VMRl9DTEFTUyA9IHRoaXM7XG5cdFx0cmV0dXJuIG5ldyBTRUxGX0NMQVNTKG9wdGlvbnMpO1xuXHR9XG5cblx0c3RhdGljIGNyZWF0ZUFzeW5jKG9wdGlvbnM/OiBzdHJpbmcgfCBJQ2FjYWNoZU9wdGlvbnMpXG5cdHtcblx0XHRsZXQgU0VMRl9DTEFTUyA9IHRoaXM7XG5cblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZSgpXG5cdFx0XHQuYmluZChTRUxGX0NMQVNTKVxuXHRcdFx0LnRoZW4oYXN5bmMgZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0b3B0aW9ucyA9IGF3YWl0IGdldE9wdGlvbnNBc3luYyhvcHRpb25zKTtcblxuXHRcdFx0XHRyZXR1cm4gbmV3IFNFTEZfQ0xBU1Mob3B0aW9ucyk7XG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0Y29uc3RydWN0b3Iob3B0aW9uczogc3RyaW5nIHwgSUNhY2FjaGVPcHRpb25zKVxuXHR7XG5cdFx0c3VwZXIoKTtcblxuXHRcdG9wdGlvbnMgPSBnZXRPcHRpb25zKG9wdGlvbnMpO1xuXG5cdFx0aWYgKCFvcHRpb25zLmNhY2hlUGF0aClcblx0XHR7XG5cdFx0XHRsZXQgZXJyID0gbmV3IEVycm9yKGBuYW1lIG9yIGNhY2hlUGF0aCBpcyB1bmRlZmluZWRgKTtcblxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0ZXJyLm9wdGlvbnMgPSBvcHRpb25zO1xuXG5cdFx0XHR0aHJvdyBlcnI7XG5cdFx0fVxuXG5cdFx0dGhpcy5jYWNoZVBhdGggPSBvcHRpb25zLmNhY2hlUGF0aDtcblxuXHRcdGlmICghZnMuZXhpc3RzU3luYyh0aGlzLmNhY2hlUGF0aCkpXG5cdFx0e1xuXHRcdFx0aWYgKG9wdGlvbnMuYXV0b0NyZWF0ZURpcilcblx0XHRcdHtcblx0XHRcdFx0ZGVidWdDb25zb2xlLmRlYnVnKGBhdXRvIGNyZWF0ZSBjYWNoZVBhdGg6ICR7dGhpcy5jYWNoZVBhdGh9YCk7XG5cdFx0XHRcdGZzLmVuc3VyZURpclN5bmModGhpcy5jYWNoZVBhdGgpXG5cdFx0XHR9XG5cdFx0XHRlbHNlXG5cdFx0XHR7XG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihg55m855Sf6Yyv6KqkIOW/q+WPluebrumMhOS4jeWtmOWcqCAnJHt0aGlzLmNhY2hlUGF0aH0nYCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0ZGVidWdDb25zb2xlLmRlYnVnKGBjYWNoZVBhdGg6ICR7dGhpcy5jYWNoZVBhdGh9YCk7XG5cdH1cblxuXHRsaXN0PE0+KCk6IGJsdWViaXJkPElDYWNhY2hlTGlzdDxNPj5cblx0e1xuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUoY2FjYWNoZS5scyh0aGlzLmNhY2hlUGF0aCkpXG5cdFx0XHQ7XG5cdH1cblxuXHRyZWFkRGF0YTxEID0gQnVmZmVyLCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogSUNhY2FjaGVPcHRpb25zQ29yZSxcblx0KTogYmx1ZWJpcmQ8SUNhY2FjaGVEYXRhPEQsIE0+PlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShjYWNhY2hlLmdldCh0aGlzLmNhY2hlUGF0aCwga2V5LCBvcHRpb25zKSk7XG5cdH1cblxuXHRyZWFkSlNPTjxEID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRvcHRpb25zPzogSUNhY2FjaGVPcHRpb25zQ29yZSxcblx0KVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMucmVhZERhdGEoa2V5LCBvcHRpb25zKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKHJldClcblx0XHRcdHtcblx0XHRcdFx0bGV0IHJldDIgPSByZXQgYXMgYW55IGFzIElDYWNhY2hlSlNPTjxELCBNPjtcblxuXHRcdFx0XHRyZXQyLmpzb24gPSBKU09OLnBhcnNlKHJldDIuZGF0YS50b1N0cmluZygpKTtcblxuXHRcdFx0XHRyZXR1cm4gcmV0Mjtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHRyZWFkRGF0YUlmRXhpc3RzPEQgPSBCdWZmZXIsIE0gPSBhbnk+KGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNQbHVzLFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZURhdGE8RCwgTT4+XG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gdGhpcy5oYXNEYXRhKGtleSwgb3B0aW9ucylcblx0XHRcdC5iaW5kKHRoaXMpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAodGhpczogQ2FjYWNoZSwgdilcblx0XHRcdHtcblx0XHRcdFx0aWYgKHYpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gc2VsZi5yZWFkRGF0YTxELCBNPihrZXksIG9wdGlvbnMpXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHRyZWFkSlNPTklmRXhpc3RzPEQgPSBhbnksIE0gPSBhbnk+KGtleTogc3RyaW5nLFxuXHRcdG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNQbHVzLFxuXHQpOiBibHVlYmlyZDxJQ2FjYWNoZUpTT048RCwgTT4+XG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gdGhpcy5oYXNEYXRhKGtleSwgb3B0aW9ucylcblx0XHRcdC5iaW5kKHRoaXMpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAodGhpczogQ2FjYWNoZSwgdilcblx0XHRcdHtcblx0XHRcdFx0aWYgKHYpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gc2VsZi5yZWFkSlNPTjxELCBNPihrZXksIG9wdGlvbnMpXG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdH0pXG5cdFx0XHQ7XG5cdH1cblxuXHRyZWFkRGF0YUluZm88TT4oa2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmUsXG5cdCk6IGJsdWViaXJkPElDYWNhY2hlTGlzdEVudHJ5PE0+PlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShjYWNhY2hlLmdldC5pbmZvKHRoaXMuY2FjaGVQYXRoLCBrZXksIG9wdGlvbnMpKTtcblx0fVxuXG5cdGhhc0NvbnRlbnQ8Tz4oaW50ZWdyaXR5OiBzdHJpbmcpOiBibHVlYmlyZDxJQ2FjYWNoZURhdGFIYXNDb250ZW50PE8+PlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkXG5cdFx0XHQucmVzb2x2ZShjYWNhY2hlLmdldC5oYXNDb250ZW50KHRoaXMuY2FjaGVQYXRoLCBpbnRlZ3JpdHkpKTtcblx0fVxuXG5cdGhhc0RhdGE8TT4oa2V5OiBzdHJpbmcsXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc1BsdXMsXG5cdClcblx0e1xuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUoKVxuXHRcdFx0LmJpbmQodGhpcylcblx0XHRcdC50aGVuKGFzeW5jIGZ1bmN0aW9uICgpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBpbmZvID0gYXdhaXQgc2VsZi5yZWFkRGF0YUluZm88TT4oa2V5KTtcblxuXHRcdFx0XHRpZiAoaW5mb1xuXHRcdFx0XHRcdCYmIG9wdGlvbnNcblx0XHRcdFx0XHQmJiBvcHRpb25zLnR0bFxuXHRcdFx0XHRcdCYmIChpbmZvLnRpbWUgKyBvcHRpb25zLnR0bCkgPD0gRGF0ZS5ub3coKVxuXHRcdFx0XHQpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhd2FpdCBzZWxmLnJlbW92ZShrZXkpO1xuXG5cdFx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gaW5mbyB8fCBudWxsO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdHdyaXRlRGF0YTxPID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRkYXRhOiBzdHJpbmcgfCBEYXRhVmlldyB8IFR5cGVkQXJyYXksXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmU8TT4sXG5cdCk6IGJsdWViaXJkPElDYWNhY2hlSW50ZWdyaXR5PElDYWNhY2hlSGFzaDxPPj4+XG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKGNhY2FjaGUucHV0KHRoaXMuY2FjaGVQYXRoLCBrZXksIGRhdGEsIG9wdGlvbnMpKVxuXHRcdFx0LmJpbmQodGhpcylcblx0XHRcdDtcblx0fVxuXG5cdHdyaXRlSlNPTjxPID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZywgZGF0YSwgb3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmU8TT4pXG5cdHtcblx0XHRyZXR1cm4gdGhpcy53cml0ZURhdGE8TywgTT4oa2V5LCBKU09OLnN0cmluZ2lmeShkYXRhKSwgb3B0aW9ucyk7XG5cdH1cblxuXHR3cml0ZURhdGFBbmRDbGVhcjxPID0gYW55LCBNID0gYW55PihrZXk6IHN0cmluZyxcblx0XHRkYXRhOiBzdHJpbmcgfCBEYXRhVmlldyB8IFR5cGVkQXJyYXksXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmU8TT4sXG5cdCk6IGJsdWViaXJkPElDYWNhY2hlSW50ZWdyaXR5PElDYWNhY2hlSGFzaDxPPj4+XG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gdGhpcy53cml0ZURhdGE8TywgTT4oa2V5LCBkYXRhLCBvcHRpb25zKVxuXHRcdFx0LnRhcChmdW5jdGlvbiAoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gc2VsZi5jbGVhcktleShrZXksIHRydWUpO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdHdyaXRlSlNPTkFuZENsZWFyPE8gPSBhbnksIE0gPSBhbnk+KGtleTogc3RyaW5nLFxuXHRcdGRhdGEsXG5cdFx0b3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmU8TT4sXG5cdCk6IGJsdWViaXJkPElDYWNhY2hlSW50ZWdyaXR5PElDYWNhY2hlSGFzaDxPPj4+XG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gdGhpcy53cml0ZUpTT048TywgTT4oa2V5LCBkYXRhLCBvcHRpb25zKVxuXHRcdFx0LnRhcChmdW5jdGlvbiAoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gc2VsZi5jbGVhcktleShrZXksIHRydWUpO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdHJlbW92ZUFsbCgpOiBibHVlYmlyZDx2b2lkPlxuXHR7XG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoY2FjYWNoZS5ybS5hbGwodGhpcy5jYWNoZVBhdGgpKTtcblx0fVxuXG5cdHJlbW92ZShrZXk6IHN0cmluZyk6IGJsdWViaXJkPHZvaWQ+XG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZShjYWNhY2hlLnJtLmVudHJ5KHRoaXMuY2FjaGVQYXRoLCBrZXkpKTtcblx0fVxuXG5cdF9zc3JpRGF0YShkYXRhOiBzdHJpbmcgfCBEYXRhVmlldyB8IFR5cGVkQXJyYXkpOiBzdHJpbmdcblx0e1xuXHRcdHJldHVybiB1dGlsLnNzcmlEYXRhKGRhdGEpXG5cdH1cblxuXHRfc3NyaUpTT04oZGF0YSwgaW50ZWdyaXR5Pzogc3RyaW5nKVxuXHR7XG5cdFx0cmV0dXJuIHRoaXMuaGFzaERhdGEoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xuXHR9XG5cblx0aGFzaERhdGEoZGF0YTogc3RyaW5nIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5KTogc3RyaW5nXG5cdHtcblx0XHRyZXR1cm4gc3NyaS5zdHJpbmdpZnkodGhpcy5fc3NyaURhdGEoZGF0YSkpO1xuXHR9XG5cblx0aGFzaEpTT04oZGF0YSlcblx0e1xuXHRcdHJldHVybiB0aGlzLmhhc2hEYXRhKEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcblx0fVxuXG5cdGNsZWFyS2V5PE0gPSBhbnk+KGtleTogc3RyaW5nLCBrZWVwTGF0ZXN0PzogYm9vbGVhbilcblx0e1xuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBibHVlYmlyZFxuXHRcdFx0LnJlc29sdmUodGhpcy5idWNrZXRFbnRyaWVzKGtleSkpXG5cdFx0XHQuYmluZCh0aGlzKVxuXHRcdFx0LnRoZW4oZnVuY3Rpb24gKGxzKVxuXHRcdFx0e1xuXHRcdFx0XHRpZiAoIWxzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdFx0XHQucmVkdWNlKGxzLCBhc3luYyBmdW5jdGlvbiAobGF0ZXN0OiBJQ2FjYWNoZUxpc3RFbnRyeTxNPiwgbmV4dDogSUNhY2FjaGVMaXN0RW50cnk8TT4pXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0aWYgKG5leHQua2V5ID09PSBrZXkpXG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdGlmIChsYXRlc3QudGltZSA+IG5leHQudGltZSlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdFtsYXRlc3QsIG5leHRdID0gW25leHQsIGxhdGVzdF07XG5cdFx0XHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdFx0XHRpZiAobmV4dC5pbnRlZ3JpdHkgIT0gbGF0ZXN0LmludGVncml0eSlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdGF3YWl0IHNlbGYucmVtb3ZlQ29udGVudChsYXRlc3QuaW50ZWdyaXR5KTtcblx0XHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRcdGxhdGVzdCA9IG5leHQ7XG5cdFx0XHRcdFx0XHR9XG5cblx0XHRcdFx0XHRcdHJldHVybiBsYXRlc3Q7XG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAobGF0ZXN0KVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGlmICgha2VlcExhdGVzdClcblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0YXdhaXQgc2VsZi5yZW1vdmVDb250ZW50KGxhdGVzdC5pbnRlZ3JpdHkpO1xuXG5cdFx0XHRcdFx0XHRcdHJldHVybiBudWxsO1xuXHRcdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0XHRyZXR1cm4gbGF0ZXN0XG5cdFx0XHRcdFx0fSlcblx0XHRcdH0pXG5cdFx0XHQudGFwKGFzeW5jIGZ1bmN0aW9uIChsYXRlc3QpXG5cdFx0XHR7XG5cdFx0XHRcdGxldCBidWNrZXQgPSBzZWxmLmJ1Y2tldFBhdGgoa2V5KTtcblxuXHRcdFx0XHRpZiAobGF0ZXN0KVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IGVudHJ5ID0gT2JqZWN0LmFzc2lnbih7fSwgbGF0ZXN0KTtcblxuXHRcdFx0XHRcdGRlbGV0ZSBlbnRyeS5wYXRoO1xuXG5cdFx0XHRcdFx0bGV0IHN0cmluZ2lmaWVkID0gSlNPTi5zdHJpbmdpZnkoZW50cnkpO1xuXG5cdFx0XHRcdFx0YXdhaXQgZnMud3JpdGVGaWxlKGJ1Y2tldC5mdWxscGF0aCwgXCJcXG5cIiArIGAke19oYXNoRW50cnkoc3RyaW5naWZpZWQpfVxcdCR7c3RyaW5naWZpZWR9YClcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRhd2FpdCBmcy5yZW1vdmUoYnVja2V0LmZ1bGxwYXRoKVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0YXdhaXQgZGVsZXRlRW1wdHkoc2VsZi5jYWNoZVBhdGgpO1xuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxuXG5cdHJlbW92ZUNvbnRlbnQoZGF0YV9pbnRlZ3JpdHk6IHN0cmluZyk6IGJsdWViaXJkPHZvaWQ+XG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZShjYWNhY2hlLnJtLmNvbnRlbnQodGhpcy5jYWNoZVBhdGgsIGRhdGFfaW50ZWdyaXR5KSk7XG5cdH1cblxuXHRjbGVhck1lbW9pemVkKClcblx0e1xuXHRcdHJldHVybiBibHVlYmlyZC5yZXNvbHZlKClcblx0XHRcdC50YXAoZnVuY3Rpb24gKClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIGNhY2FjaGUuY2xlYXJNZW1vaXplZCgpXG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0Y3JlYXRlVGVtcERpclBhdGgob3B0aW9ucz86IElDYWNhY2hlT3B0aW9uc0NvcmUpOiBibHVlYmlyZDxzdHJpbmc+XG5cdHtcblx0XHRyZXR1cm4gYmx1ZWJpcmQucmVzb2x2ZShjYWNhY2hlLnRtcC5ta2Rpcih0aGlzLmNhY2hlUGF0aCwgb3B0aW9ucykpO1xuXHR9XG5cblx0d2l0aFRlbXBEaXJQYXRoKG9wdGlvbnM/OiBJQ2FjYWNoZU9wdGlvbnNDb3JlKTogYmx1ZWJpcmQ8c3RyaW5nPlxuXHR7XG5cdFx0cmV0dXJuIG5ldyBibHVlYmlyZCgocmVzb2x2ZSwgcmVqZWN0KSA9PlxuXHRcdHtcblx0XHRcdGNhY2FjaGUudG1wLndpdGhUbXAodGhpcy5jYWNoZVBhdGgsIHJlc29sdmUsIG9wdGlvbnMpXG5cdFx0fSk7XG5cdH1cblxuXHRidWNrZXRQYXRoKGtleTogc3RyaW5nKVxuXHR7XG5cdFx0cmV0dXJuIHV0aWwuYnVja2V0UGF0aChrZXksIHRoaXMuY2FjaGVQYXRoKTtcblx0fVxuXG5cdGNvbnRlbnRQYXRoKGludGVncml0eTogc3RyaW5nKVxuXHR7XG5cdFx0cmV0dXJuIHV0aWwuY29udGVudFBhdGgoaW50ZWdyaXR5LCB0aGlzLmNhY2hlUGF0aCk7XG5cdH1cblxuXHRidWNrZXRFbnRyaWVzPE0gPSBhbnk+KGtleTogc3RyaW5nKVxuXHR7XG5cdFx0bGV0IHNlbGYgPSB0aGlzO1xuXG5cdFx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUoKVxuXHRcdFx0LmJpbmQodGhpcylcblx0XHRcdC50aGVuKGZ1bmN0aW9uICh0aGlzOiBDYWNhY2hlKVxuXHRcdFx0e1xuXHRcdFx0XHRsZXQgYnVja2V0ID0gc2VsZi5idWNrZXRQYXRoKGtleSk7XG5cblx0XHRcdFx0aWYgKCFmcy5leGlzdHNTeW5jKGJ1Y2tldC5mdWxscGF0aCkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRyZXR1cm4gbnVsbDtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJldHVybiBmcy5yZWFkRmlsZShidWNrZXQuZnVsbHBhdGgsICd1dGY4Jylcblx0XHRcdFx0XHQudGhlbihkYXRhID0+XG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGV0IGVudHJpZXMgPSBbXSBhcyBJQ2FjYWNoZUxpc3RFbnRyeTxNPltdO1xuXG5cdFx0XHRcdFx0XHRkYXRhLnNwbGl0KCdcXG4nKS5mb3JFYWNoKGVudHJ5ID0+XG5cdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdGlmICghZW50cnkpXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm5cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRjb25zdCBwaWVjZXMgPSBlbnRyeS5zcGxpdCgnXFx0Jyk7XG5cdFx0XHRcdFx0XHRcdGlmICghcGllY2VzWzFdIHx8IF9oYXNoRW50cnkocGllY2VzWzFdKSAhPT0gcGllY2VzWzBdKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gSGFzaCBpcyBubyBnb29kISBDb3JydXB0aW9uIG9yIG1hbGljZT8gRG9lc24ndCBtYXR0ZXIhXG5cdFx0XHRcdFx0XHRcdFx0Ly8gRUpFQ1QgRUpFQ1Rcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm5cblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0XHRsZXQgb2JqO1xuXHRcdFx0XHRcdFx0XHR0cnlcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdG9iaiA9IEpTT04ucGFyc2UocGllY2VzWzFdKVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdGNhdGNoIChlKVxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gRW50cnkgaXMgY29ycnVwdGVkIVxuXHRcdFx0XHRcdFx0XHRcdHJldHVyblxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRcdGlmIChvYmopXG5cdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRvYmoucGF0aCA9IHNlbGYuY29udGVudFBhdGgob2JqLmludGVncml0eSkuZnVsbHBhdGg7XG5cblx0XHRcdFx0XHRcdFx0XHRlbnRyaWVzLnB1c2gob2JqKVxuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdHJldHVybiBlbnRyaWVzXG5cdFx0XHRcdFx0fSlcblx0XHRcdFx0XHQ7XG5cdFx0XHR9KVxuXHRcdFx0O1xuXHR9XG5cblx0ZGVzdHJveSgpXG5cdHtcblx0XHRsZXQgc2VsZiA9IHRoaXM7XG5cblx0XHRyZXR1cm4gYmx1ZWJpcmRcblx0XHRcdC5yZXNvbHZlKHNlbGYuZW1pdCgnZGVzdHJveScpKVxuXHRcdFx0LnRhcChmdW5jdGlvbiAoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm4gYmx1ZWJpcmQuYWxsKFtcblx0XHRcdFx0XHRzZWxmLnJlbW92ZUFsbExpc3RlbmVycygpLFxuXHRcdFx0XHRdKVxuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxufVxuXG50eXBlIHZhbHVlb2Y8VD4gPSBUW2tleW9mIFRdXG5cbmV4cG9ydCB0eXBlIElDYWNhY2hlQWxnb3JpdGhtID0gJ3NoYTUxMicgfCBzdHJpbmc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVJbnRlZ3JpdHk8VCA9IElDYWNhY2hlSGFzaD5cbntcblx0c2hhNTEyPzogVFtdLFxuXG5cdFtrOiBzdHJpbmddOiBUW10sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVIYXNoPE8gPSBhbnk+XG57XG5cdHNvdXJjZTogc3RyaW5nLFxuXHRhbGdvcml0aG06IElDYWNhY2hlQWxnb3JpdGhtLFxuXHRkaWdlc3Q6IHN0cmluZyxcblx0b3B0aW9uczogT1tdLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElDYWNhY2hlTGlzdEVudHJ5PE0gPSBhbnk+XG57XG5cdGtleTogc3RyaW5nLFxuXHRpbnRlZ3JpdHk6IHN0cmluZyxcblx0cGF0aDogc3RyaW5nLFxuXHRzaXplOiBudW1iZXIsXG5cdHRpbWU6IG51bWJlcixcblx0bWV0YWRhdGE6IE0sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVMaXN0PE0gPSBhbnk+XG57XG5cdFtrOiBzdHJpbmddOiBJQ2FjYWNoZUxpc3RFbnRyeTxNPixcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJQ2FjYWNoZURhdGE8RCA9IEJ1ZmZlciwgTSA9IGFueT5cbntcblx0bWV0YWRhdGE6IE0sXG5cdGludGVncml0eTogc3RyaW5nLFxuXHRkYXRhOiBEIHwgQnVmZmVyIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5LFxuXHRzaXplOiBzdHJpbmcsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVKU09OPEQgPSBCdWZmZXIsIE0gPSBhbnk+XG57XG5cdG1ldGFkYXRhOiBNLFxuXHRpbnRlZ3JpdHk6IHN0cmluZyxcblx0ZGF0YTogQnVmZmVyIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5LFxuXHRzaXplOiBzdHJpbmcsXG5cdGpzb246IEQsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSUNhY2FjaGVEYXRhSGFzQ29udGVudDxPID0gYW55Plxue1xuXHRzcmk6IElDYWNhY2hlSGFzaDxPPixcblx0c2l6ZTogbnVtYmVyLFxufVxuXG5leHBvcnQgZGVmYXVsdCBDYWNhY2hlXG5cbi8vIEB0cy1pZ25vcmVcbmV4cG9ydCA9IE9iamVjdC5mcmVlemUoT2JqZWN0LmFzc2lnbihDYWNhY2hlLCBleHBvcnRzLCB7XG5cdGRlZmF1bHQ6IENhY2FjaGUsXG5cdENhY2FjaGUsXG59KSBhcyB0eXBlb2YgQ2FjYWNoZSAmIHtcblx0ZGVmYXVsdDogdHlwZW9mIENhY2FjaGUsXG5cdENhY2FjaGU6IHR5cGVvZiBDYWNhY2hlLFxufSk7XG4iXX0=