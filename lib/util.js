"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const entry_index_1 = require("cacache/lib/entry-index");
const cache_path_1 = require("cache-path");
const bluebird = require("bluebird");
const debug_color2_1 = require("debug-color2");
const path = require("upath2");
const deleteEmpty = require("delete-empty");
exports.deleteEmpty = deleteEmpty;
const _contentPath = require("cacache/lib/content/path");
const ssri = require("ssri");
exports.debugConsole = new debug_color2_1.Console(null, {
    label: true,
    time: true,
});
exports.debugConsole.inspectOptions = {
    colors: exports.debugConsole.enabledColor,
};
exports.debugConsole.enabled = false;
function enableDebug(bool) {
    if (bool || typeof bool === 'undefined') {
        exports.debugConsole.enabled = true;
    }
    else if (bool === false) {
        exports.debugConsole.enabled = false;
    }
    return exports.debugConsole.enabled;
}
exports.enableDebug = enableDebug;
function getCacheDirPath(name, options, isAsync) {
    options = options || {};
    let fnOrder = [];
    if (options.getCachePathOptions && options.getCachePathOptions.fnOrder) {
        fnOrder.push(...options.getCachePathOptions.fnOrder);
    }
    if (options.useGlobalCache) {
        fnOrder.push(...[
            cache_path_1.findNpmCachePath,
            cache_path_1.getOSTempPath,
            cache_path_1.findPkgModulePath,
        ]);
    }
    if (!fnOrder || !fnOrder.length) {
        fnOrder = null;
    }
    let opts = {
        ...options.getCachePathOptions,
        name,
        create: true,
        fnOrder,
    };
    let fn = isAsync ? cache_path_1.getCachePathAsync : cache_path_1.getCachePath;
    return fn(opts);
}
exports.getCacheDirPath = getCacheDirPath;
function getOptions(options) {
    if (typeof options === 'string') {
        options = {
            name: options,
        };
    }
    options = options || {};
    if (!options.cachePath && options.name) {
        options.cachePath = getCacheDirPath(options.name, options);
    }
    options.getCachePathOptions = options.getCachePathOptions || {};
    return options;
}
exports.getOptions = getOptions;
function getOptionsAsync(options) {
    if (typeof options === 'string') {
        options = {
            name: options,
        };
    }
    return bluebird.resolve(options || {})
        .then(async function (options) {
        if (!options.cachePath && options.name) {
            options.cachePath = await getCacheDirPath(options.name, options, true);
        }
        options.getCachePathOptions = options.getCachePathOptions || {};
        return options;
    });
}
exports.getOptionsAsync = getOptionsAsync;
function bucketPath(key, cachePath) {
    let fullpath = entry_index_1._bucketPath(cachePath, key);
    let p = path.relative(cachePath, fullpath);
    return {
        fullpath,
        path: p,
    };
}
exports.bucketPath = bucketPath;
function contentPath(integrity, cachePath) {
    let fullpath = _contentPath(cachePath, integrity);
    let p = path.relative(cachePath, fullpath);
    return {
        fullpath,
        path: p,
    };
}
exports.contentPath = contentPath;
function ssriData(data) {
    return ssri.fromData(data);
}
exports.ssriData = ssriData;
function ssriJSON(data, integrity) {
    return hashData(JSON.stringify(data));
}
exports.ssriJSON = ssriJSON;
function hashData(data) {
    return ssri.stringify(ssriData(data));
}
exports.hashData = hashData;
// @ts-ignore
exports = Object.freeze(exports);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5REFBc0Q7QUFDdEQsMkNBQWlIO0FBQ2pILHFDQUFzQztBQUN0QywrQ0FBdUM7QUFDdkMsK0JBQWdDO0FBRWhDLDRDQUE2QztBQUtwQyxrQ0FBVztBQUpwQix5REFBMEQ7QUFDMUQsNkJBQThCO0FBS2pCLFFBQUEsWUFBWSxHQUFHLElBQUksc0JBQU8sQ0FBQyxJQUFJLEVBQUU7SUFDN0MsS0FBSyxFQUFFLElBQUk7SUFDWCxJQUFJLEVBQUUsSUFBSTtDQUNWLENBQUMsQ0FBQztBQUVILG9CQUFZLENBQUMsY0FBYyxHQUFHO0lBQzdCLE1BQU0sRUFBRSxvQkFBWSxDQUFDLFlBQVk7Q0FDakMsQ0FBQztBQUVGLG9CQUFZLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztBQUU3QixTQUFnQixXQUFXLENBQUMsSUFBYztJQUV6QyxJQUFJLElBQUksSUFBSSxPQUFPLElBQUksS0FBSyxXQUFXLEVBQ3ZDO1FBQ0Msb0JBQVksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0tBQzVCO1NBQ0ksSUFBSSxJQUFJLEtBQUssS0FBSyxFQUN2QjtRQUNDLG9CQUFZLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztLQUM3QjtJQUVELE9BQU8sb0JBQVksQ0FBQyxPQUFPLENBQUM7QUFDN0IsQ0FBQztBQVpELGtDQVlDO0FBSUQsU0FBZ0IsZUFBZSxDQUFDLElBQVksRUFBRSxPQUF3QixFQUFFLE9BQWlCO0lBRXhGLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO0lBRXhCLElBQUksT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUVqQixJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsSUFBSSxPQUFPLENBQUMsbUJBQW1CLENBQUMsT0FBTyxFQUN0RTtRQUNDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFD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QUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7QUFDM0IsQ0FBQztBQUhELDRCQUdDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLElBQUksRUFBRSxTQUFrQjtJQUVoRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDdkMsQ0FBQztBQUhELDRCQUdDO0FBRUQsU0FBZ0IsUUFBUSxDQUFDLElBQW9DO0lBRTVELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBSEQsNEJBR0M7QUFFRCxhQUFhO0FBQ2IsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBfYnVja2V0UGF0aCB9IGZyb20gJ2NhY2FjaGUvbGliL2VudHJ5LWluZGV4JztcbmltcG9ydCB7IGdldENhY2hlUGF0aCwgZmluZE5wbUNhY2hlUGF0aCwgZ2V0T1NUZW1wUGF0aCwgZmluZFBrZ01vZHVsZVBhdGgsIGdldENhY2hlUGF0aEFzeW5jIH0gZnJvbSAnY2FjaGUtcGF0aCc7XG5pbXBvcnQgYmx1ZWJpcmQgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuaW1wb3J0IHsgQ29uc29sZSB9IGZyb20gJ2RlYnVnLWNvbG9yMic7XG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3VwYXRoMicpO1xuaW1wb3J0IHsgSUNhY2FjaGVPcHRpb25zIH0gZnJvbSAnLi4vaW5kZXgnO1xuaW1wb3J0IGRlbGV0ZUVtcHR5ID0gcmVxdWlyZSgnZGVsZXRlLWVtcHR5Jyk7XG5pbXBvcnQgX2NvbnRlbnRQYXRoID0gcmVxdWlyZSgnY2FjYWNoZS9saWIvY29udGVudC9wYXRoJyk7XG5pbXBvcnQgc3NyaSA9IHJlcXVpcmUoJ3NzcmknKTtcbmltcG9ydCBUeXBlZEFycmF5ID0gTm9kZUpTLlR5cGVkQXJyYXk7XG5cbmV4cG9ydCB7IGRlbGV0ZUVtcHR5IH1cblxuZXhwb3J0IGNvbnN0IGRlYnVnQ29uc29sZSA9IG5ldyBDb25zb2xlKG51bGwsIHtcblx0bGFiZWw6IHRydWUsXG5cdHRpbWU6IHRydWUsXG59KTtcblxuZGVidWdDb25zb2xlLmluc3BlY3RPcHRpb25zID0ge1xuXHRjb2xvcnM6IGRlYnVnQ29uc29sZS5lbmFibGVkQ29sb3IsXG59O1xuXG5kZWJ1Z0NvbnNvbGUuZW5hYmxlZCA9IGZhbHNlO1xuXG5leHBvcnQgZnVuY3Rpb24gZW5hYmxlRGVidWcoYm9vbD86IGJvb2xlYW4pXG57XG5cdGlmIChib29sIHx8IHR5cGVvZiBib29sID09PSAndW5kZWZpbmVkJylcblx0e1xuXHRcdGRlYnVnQ29uc29sZS5lbmFibGVkID0gdHJ1ZTtcblx0fVxuXHRlbHNlIGlmIChib29sID09PSBmYWxzZSlcblx0e1xuXHRcdGRlYnVnQ29uc29sZS5lbmFibGVkID0gZmFsc2U7XG5cdH1cblxuXHRyZXR1cm4gZGVidWdDb25zb2xlLmVuYWJsZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDYWNoZURpclBhdGgobmFtZTogc3RyaW5nLCBvcHRpb25zOiBJQ2FjYWNoZU9wdGlvbnMsIGlzQXN5bmM6IHRydWUpOiBibHVlYmlyZDxzdHJpbmc+XG5leHBvcnQgZnVuY3Rpb24gZ2V0Q2FjaGVEaXJQYXRoKG5hbWU6IHN0cmluZywgb3B0aW9uczogSUNhY2FjaGVPcHRpb25zLCBpc0FzeW5jPzogYm9vbGVhbik6IHN0cmluZ1xuZXhwb3J0IGZ1bmN0aW9uIGdldENhY2hlRGlyUGF0aChuYW1lOiBzdHJpbmcsIG9wdGlvbnM6IElDYWNhY2hlT3B0aW9ucywgaXNBc3luYz86IGJvb2xlYW4pXG57XG5cdG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuXG5cdGxldCBmbk9yZGVyID0gW107XG5cblx0aWYgKG9wdGlvbnMuZ2V0Q2FjaGVQYXRoT3B0aW9ucyAmJiBvcHRpb25zLmdldENhY2hlUGF0aE9wdGlvbnMuZm5PcmRlcilcblx0e1xuXHRcdGZuT3JkZXIucHVzaCguLi5vcHRpb25zLmdldENhY2hlUGF0aE9wdGlvbnMuZm5PcmRlcik7XG5cdH1cblxuXHRpZiAob3B0aW9ucy51c2VHbG9iYWxDYWNoZSlcblx0e1xuXHRcdGZuT3JkZXIucHVzaCguLi5bXG5cdFx0XHRmaW5kTnBtQ2FjaGVQYXRoLFxuXHRcdFx0Z2V0T1NUZW1wUGF0aCxcblx0XHRcdGZpbmRQa2dNb2R1bGVQYXRoLFxuXHRcdF0pO1xuXHR9XG5cblx0aWYgKCFmbk9yZGVyIHx8ICFmbk9yZGVyLmxlbmd0aClcblx0e1xuXHRcdGZuT3JkZXIgPSBudWxsO1xuXHR9XG5cblx0bGV0IG9wdHMgPSB7XG5cdFx0Li4ub3B0aW9ucy5nZXRDYWNoZVBhdGhPcHRpb25zLFxuXHRcdG5hbWUsXG5cdFx0Y3JlYXRlOiB0cnVlLFxuXHRcdGZuT3JkZXIsXG5cdH07XG5cblx0bGV0IGZuID0gaXNBc3luYyA/IGdldENhY2hlUGF0aEFzeW5jIDogZ2V0Q2FjaGVQYXRoO1xuXG5cdHJldHVybiBmbihvcHRzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvbnMob3B0aW9ucz86IHN0cmluZyB8IElDYWNhY2hlT3B0aW9ucylcbntcblx0aWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJylcblx0e1xuXHRcdG9wdGlvbnMgPSB7XG5cdFx0XHRuYW1lOiBvcHRpb25zLFxuXHRcdH1cblx0fVxuXG5cdG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuXG5cdGlmICghb3B0aW9ucy5jYWNoZVBhdGggJiYgb3B0aW9ucy5uYW1lKVxuXHR7XG5cdFx0b3B0aW9ucy5jYWNoZVBhdGggPSBnZXRDYWNoZURpclBhdGgob3B0aW9ucy5uYW1lLCBvcHRpb25zKTtcblx0fVxuXG5cdG9wdGlvbnMuZ2V0Q2FjaGVQYXRoT3B0aW9ucyA9IG9wdGlvbnMuZ2V0Q2FjaGVQYXRoT3B0aW9ucyB8fCB7fTtcblxuXHRyZXR1cm4gb3B0aW9ucztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvbnNBc3luYyhvcHRpb25zPzogc3RyaW5nIHwgSUNhY2FjaGVPcHRpb25zKVxue1xuXHRpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKVxuXHR7XG5cdFx0b3B0aW9ucyA9IHtcblx0XHRcdG5hbWU6IG9wdGlvbnMsXG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIGJsdWViaXJkLnJlc29sdmUob3B0aW9ucyB8fCB7fSlcblx0XHQudGhlbihhc3luYyBmdW5jdGlvbiAob3B0aW9uczogSUNhY2FjaGVPcHRpb25zKVxuXHRcdHtcblx0XHRcdGlmICghb3B0aW9ucy5jYWNoZVBhdGggJiYgb3B0aW9ucy5uYW1lKVxuXHRcdFx0e1xuXHRcdFx0XHRvcHRpb25zLmNhY2hlUGF0aCA9IGF3YWl0IGdldENhY2hlRGlyUGF0aChvcHRpb25zLm5hbWUsIG9wdGlvbnMsIHRydWUpO1xuXHRcdFx0fVxuXG5cdFx0XHRvcHRpb25zLmdldENhY2hlUGF0aE9wdGlvbnMgPSBvcHRpb25zLmdldENhY2hlUGF0aE9wdGlvbnMgfHwge307XG5cblx0XHRcdHJldHVybiBvcHRpb25zO1xuXHRcdH0pXG5cdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGJ1Y2tldFBhdGgoa2V5OiBzdHJpbmcsIGNhY2hlUGF0aDogc3RyaW5nKVxue1xuXHRsZXQgZnVsbHBhdGg6IHN0cmluZyA9IF9idWNrZXRQYXRoKGNhY2hlUGF0aCwga2V5KTtcblxuXHRsZXQgcCA9IHBhdGgucmVsYXRpdmUoY2FjaGVQYXRoLCBmdWxscGF0aCk7XG5cblx0cmV0dXJuIHtcblx0XHRmdWxscGF0aCxcblx0XHRwYXRoOiBwLFxuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb250ZW50UGF0aChpbnRlZ3JpdHk6IHN0cmluZywgY2FjaGVQYXRoOiBzdHJpbmcpXG57XG5cdGxldCBmdWxscGF0aDogc3RyaW5nID0gX2NvbnRlbnRQYXRoKGNhY2hlUGF0aCwgaW50ZWdyaXR5KTtcblxuXHRsZXQgcCA9IHBhdGgucmVsYXRpdmUoY2FjaGVQYXRoLCBmdWxscGF0aCk7XG5cblx0cmV0dXJuIHtcblx0XHRmdWxscGF0aCxcblx0XHRwYXRoOiBwLFxuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzc3JpRGF0YShkYXRhOiBzdHJpbmcgfCBEYXRhVmlldyB8IFR5cGVkQXJyYXkpOiBzdHJpbmdcbntcblx0cmV0dXJuIHNzcmkuZnJvbURhdGEoZGF0YSlcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHNzcmlKU09OKGRhdGEsIGludGVncml0eT86IHN0cmluZyk6IHN0cmluZ1xue1xuXHRyZXR1cm4gaGFzaERhdGEoSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaGFzaERhdGEoZGF0YTogc3RyaW5nIHwgRGF0YVZpZXcgfCBUeXBlZEFycmF5KTogc3RyaW5nXG57XG5cdHJldHVybiBzc3JpLnN0cmluZ2lmeShzc3JpRGF0YShkYXRhKSk7XG59XG5cbi8vIEB0cy1pZ25vcmVcbmV4cG9ydHMgPSBPYmplY3QuZnJlZXplKGV4cG9ydHMpO1xuIl19